version: '3.8'
services:
  app:
    image: eclipse-temurin:21-jdk
    container_name: auth-backend-app-dev
    working_dir: /home/app
    # Mount the project into the container so code changes on the host are visible
    volumes:
      - ./:/home/app
      # Mount the gradle cache into the actual Gradle user home used by the container (root)
      - gradle-cache:/root/.gradle
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      # Use the same datasource env vars as the main compose file; they default to postgres service
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:-jdbc:postgresql://postgres:5432/auth}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:-postgres}
      # Activate an explicit dev profile if you want separate properties
      SPRING_PROFILES_ACTIVE: dev
    depends_on:
      - postgres
    # Ensure the wrapper is executable and run a small script that starts a continuous
    # compile in the background and then bootRun. This lets Spring DevTools restart the app
    # when compiled classes change, so Java edits are reflected without rebuilding the image.
    command: ["sh", "-c", "chmod +x ./gradlew || true; sh ./scripts/dev-entrypoint.sh"]

volumes:
  gradle-cache:
